---
title: 'Tutorial'
output:
  rmarkdown::html_vignette:
    toc: false
    toc_depth: 4
    number_sections: false
bibliography: cttb.bib      
vignette: >
  %\VignetteIndexEntry{Tutorial}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}  
---
<!-- 
  Code to Justify Text
    <style>
    body {
    text-align: justify}
    </style>
-->   
```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```  

In this tutorial, we illustrate how to use the **CTB** package in **R** to implement covariate-tightened trimming bounds method proposed by @samii2023generalizing. We start with a simulated dataset. 

##  Simulated data

**fect**  ships two datasets. In this demo, we will primarily be using **simdata**, in which the treatment is allowed to switch on and off. There are 200 units and 35 time periods. We describe its DGP in the [paper](https://papers.ssrn.com/abstract=3555463). 
```{r message = FALSE, warning = FALSE}
set.seed(1234)
library(fect)
data(fect)
ls()
```

### Visualizing missing data

Before conducting any statistical analysis, we use the **panelView** package to visualize the treatment and outcome variables in the data. 
The following line of code plots the treatment status of all units in **simdata**:
```{r simdata_panelview_treat, message = FALSE, warning = FALSE, fig.width = 6, fig.height = 4.5}

```


## Covariate-tightened trimming bounds

In the current version of **fect**, we use three methods to make counterfactual predictions by specifying the `method` option: "fe" (two-way fixed effects, default), "ife" (interactive fixed effects), and "mc" (matrix completion method). First, we illustrate the main syntax of **fect** using the "fe" method.

### Aggregated bounds
**Estimation.** We estimate the average treatment effect on the treated (ATT) using the following information: the outcome variable $Y$, binary treatment variable $D$, two observed covariates $X_{1}$ and $X_{2}$, and the unit and time indicators $id$ and $time$, respectively. The first variable on the right hand side of the formula is the treatment indicator $D$; the rest of the right-hand-side variables serve as controls. The `index` option specifies the unit and time indicators. The `force` option ("none", "unit", "time", and "two-way") specifies the additive component(s) of the fixed effects included in the model. 
The default option is "two-way" (including both unit and time fixed effects). 


**Uncertainty estimates.** The algorithm produces uncertainty estimates when `se = TRUE`. One can use the non-parametric bootstrap procedure by setting `vartype = "bootstrap"`. Note that it only works well when the number of units is relatively large and many experience the treatment condition. The number of bootstrap runs is set by `nboots`. 

Alternatively, users can obtain uncertainty estimates using the jackknife method by specifying `vartype = "jackknife"`. The algorithm obtains standard errors by iteratively dropping one unit (the entire time-series) from the dataset. 

Parallel computing will speed up both cross-validation and uncertainty estimation significantly. When `parallel = TRUE` (default) and `cores` options are omitted, the algorithm will detect the number of available cores on your computer automatically. (Warning: it may consume most of your computer's computational power if all cores are being used.)

**Result summary.** Users can use the **print** function to take a look at a summary of the estimation results or retrieve relevant statistics by directly accessing the fect object. 
Specifically, `est.avg` and `est.avg.unit` show the ATT averaged over all periods -- the former weights each treated observation equally while the latter weights each treated unit equally. 
`est.beta` reports the coefficients of the time-varying covariates. `est.att` reports the average treatment effect on the treated (ATT) by period. Treatment effect estimates from each bootstrap run is stored in `eff.boot`, an array whose dimension = (#time periods * #treated * #bootstrap runs).


### Conditional bounds


### Lee bounds

The package **fect** provides the option balance.period which allows the calculation of the average treatment effects only for units that exhibit complete data in specified pre- and post-treatment periods. For instance, if the option is set to `balance.period = c(-3,4)`, the program will calculate the average treatment effects for units that have at least four consecutive non-missing observations in the pre-treatment periods (-3, -2, -1, 0) and at least four consecutive non-missing observations in the post-treatment periods (1, 2, 3, 4).

We can then visualize the dynamic treatment effects using the inbuilt function **plot**. By default, it displays the dynamic treatment effects of the "balanced" sample.


## Heterogeneous treatment effects


## Additional Notes

1. By default, the program will drop the units that have no larger than 5 observations under control, 
which is the reason why sometimes there are less available units in the placebo test or carryover test than in the original estimation. We can specify a preferred criteria in the option `min.T0` (default to 5). 
As a rule of thumb for the IFE estimator, the minimum number of observations under control for a unit should be larger than the specified number of factor `r`.

2. We can get replicable results by setting the option `seed` to a certain integer, no matter whether the parallel computing is used.

3. When `na.rm = FALSE` (default), the program allows observations to have missing outcomes $Y$ or covariates $X$ but decided treatment statuses $D$. Otherwise the program will drop all observations that have missing values in outcomes, treatments, or covariates. 

---

# Reference
